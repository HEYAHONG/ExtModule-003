# 说明

本工程作为基础模板，可使用以下方式编译:

- [MDK](MDK-ARM):安装好MDK环境后打开目录下的工程文件即可编译。
- [GCC](GCC)：采用[CMake](https://cmake.org)管理源代码，一般用于各种IDE打开编译。

# 初始化与循环

导出初始化或者循环时,需要设置优先级。

优先级可相同，优先级相同的初始化或者循环的执行顺序由链接顺序决定。

默认情况下，优先级(数字越小，优先级越高)分配如下:

| 优先级范围 | 说明                          | 备注 |
| ---------- | ----------------------------- | ---- |
| [0,15]     | 驱动使用的优先级              |      |
| [16,31]    | 系统栈（网络栈）使用的优先级  |      |
| [32,47]    | 用户服务/环境设置使用的优先级 |      |
| [48,63]    | 应用使用的优先级              |      |

# 引脚分配

| 引脚 | 默认功能    | 说明                           |
| ---- | ----------- | ------------------------------ |
| PA0  | XL2400P_SCK | SIP内部连接，用于与XL2400P通信 |
| PA1  | XL2400P_CSN | SIP内部连接，用于与XL2400P通信 |
| PF1  | XL2400P_SDO | SIP内部连接，用于与XL2400P通信 |
| PF3  | XL2400P_SDI | SIP内部连接，用于与XL2400P通信 |
| PB0  | NET_LED     | 网络状态指示灯                 |
| PB1  | SYS_LED     | 系统状态指示灯                 |
| PA6  | NET_RX_LED  | 网络接收指示灯                 |
| PA7  | NET_TX_LED  | 网络发送成功指示灯             |
| PA15 | PSRAM_CSN   | PSRAM片选                      |
| PB3  | PSRAM_SCK   | PSRAM时钟                      |
| PB4  | PSRAM_MISO  | PSRAM SO                       |
| PB5  | PSRAM_MOSI  | PSRAM SI                       |
| PA2  | U1TX        | 串口1TX                        |
| PA3  | U1RX        | 串口1RX                        |
| PA4  | U2TX        | 串口2TX                        |
| PA5  | U2RX        | 串口2RX                        |

# XL2400P

L2400P 系列芯片是工作在 2.400~2.483GHz 世界通用 ISM 频段的单片无线收发芯片。该芯片集成射频收发机、频率收生器、晶体振荡、调制解调器等功能模块，并且支持一对多组网和带 ACK 的通信模式。

## 信道

理论上XL2400P支持2400~2483信道。

RF_CH寄存器也可写入支持的信道值。

注意:在本工程的配置中 **PRX（接收）的信道值=PTX（发送）的信道值-1** ,错误的信道配置可能导致不能正常通信。

## 通道地址

由于通道0可用于增强模式，故而通道0的默认地址仍为芯片默认地址。

通常情况下，如果不使用增强模式，可使用通道0作为广播/任播的接收通道。

通道1~5的默认地址的高32位相同，本工程中将其设置为芯片唯一ID的CRC32校验值，可用于避免默认情况下地址重复。

## 寄存器检测

对于非直接集成在SOC内部的外设而言，时时检测配置寄存器是一个提高健壮性的方法。

对于不使用XL2409直接使用PY32F030x8+XL2400P时，必须检测寄存器防止XL2400P意外复位。

## 增强模式

默认情况下，即使用XL2400P的增强模式,即由XL2400P自动处理重传及应答。

注意:此模式下，**连续传输相同的数据时，除第一个数据包外，后续数据包将被忽略**。因此，一定要在数据包中设计类似序号的字段使得连续的数据包不同。

# 产品配置

可使用的宏定义配置如下:

| 名称         | 说明     | 备注                                 |
| ------------ | -------- | ------------------------------------ |
| PRODUCT_NAME | 产品名称 | 可用于生成产品ID(用于无线网络认证)   |
| PRODUCT_PSK  | 产品密码 | 可用于生成产品密钥(用于无线网络加密) |

产品配置中可提供以下功能:

- 提供产品配置:产品ID(UUID)、公共通道地址、私有通道地址等。
- 提供基于产品配置的加密/解密。
- 提供压缩/解压缩功能。
- 提供产品功能的开启与关闭

# 控制台

控制台将占用串口1。

控制台可通过产品配置配置,主要使用以下宏定义配置:

| 宏定义                   | 说明           | 备注                                   |
| ------------------------ | -------------- | -------------------------------------- |
| `PRODUCT_CONSOLE_ENABLE` | 启用控制台输出 | 启用后可使用`console_printf`输出日志。 |
| `PRODUCT_SHELL_ENABLE`   | 启用hshell     | 启用后可使用hshell交互。               |



# 无线协议栈

默认情况下启用动态数据长度(直接通过硬件获取长度)与硬件CRC(2字节)，故而要求不高时数据帧中可省略相应数据帧字段。

## 加密

通常情况下需要对关键的数据帧字段加密,默认情况下加密方法如下:

- 采用产品配置中的加密/解密功能，通产采用chacha20。
- 计数器初值一般采用数据帧中的其它字段。
- 对于公共通道的通信(如广播等),一次性数字采用默认值。
- 对于私有通道的通信(如单播等)的一般通信,一次性数字采用 接收方私有通道地址(6字节)+公共通道地址(6字节) 。
- 对于私有通道的通信(如单播等)的特殊通信(重要数据)，一次性数字采用 接收方私有通道地址(6字节)+自定义数据(6字节) 。

## 数据帧

### 一般数据帧

注意:本章节说明为推荐帧结构，具体可根据实际需要调整。

| 字节           | 说明         | 备注                                                        |
| -------------- | ------------ | ----------------------------------------------------------- |
| [0 3]          | 数据帧头     | 若数据帧中含有加密内容,通常用作加密的计数器初值(小端模式)。 |
| [4 31]/[4 127] | 数据帧数据区 | 根据是否启用128字节长包确定字节范围。                       |

#### 数据帧头

| 字节(内部偏移) | 说明             | 备注                                                         |
| -------------- | ---------------- | ------------------------------------------------------------ |
| 0              | 数据帧头标志     | 此字段不可用于其它用途。                                     |
| 1              | 数据帧数据区CRC8 | 若有数据帧数据区加密或者数据帧数据区压缩，则需要将数据区解密并且解压缩后再计算CRC8。此字段也可用于其它用途(由数据帧类型决定)。 |
| [2 3]          | 帧序号           | 16位无符号整数,小端模式，具体用途由用户定义,一般用于确保连续发送的数据帧不同与减少加密密钥流泄露的风险。此字段也可用于其它用途(由数据帧类型决定)。 |

数据帧头标志定义如下:

| 位    |                    |                                                              |
| ----- | ------------------ | ------------------------------------------------------------ |
| 0     | 数据帧数据区已加密 | 数据帧数据区部分加密不在此标志上反应。                       |
| 1     | 数据帧数据区已压缩 | 数据帧数据区部分压缩不在此标志上反应。                       |
| [2 4] | 数据帧通道编号     | 公共通道时编号为0。此字段也可用于其它用途(由数据帧类型决定)。 |
| [5 7] | 数据帧类型         | 用于区分不同的数据帧。                                       |

数据区类型定义如下:

| 值   | 说明                                     |
| ---- | ---------------------------------------- |
| 0    | 数据帧为上电数据帧、广播数据帧其中之一。 |

### 上电数据帧

| 字节    | 说明         | 备注                                                         |
| ------- | ------------ | ------------------------------------------------------------ |
| [0 3]   | 数据帧头     | 设置为0x00,与其它类型的数据帧不同                            |
| [4 19]  | 产品ID(UUID) | 用于判断产品类型。                                           |
| [20 31] | 自定义数据   | 默认情况下为 字符串hello(6字节)+私有通道地址(6字节,不够可填充)。注意:此字段需要采用加密 |

上电数据帧上电时发送(无需应答)，当其它对应的设备收到此数据帧时表示该设备与新上电的设备可直接通信。

此数据帧仅在公共通道使用，加密字段时采用公共通道加密方式，计数器初值采用数据帧头，一次性数字采用默认值。

### 广播数据帧

广播数据帧主要用于透传数据。

广播数据帧主要有以下特点:

- 数据帧仅在公共通道使用(不采用ACK)。
- 帧格式符合一般数据帧的定义,其中数据帧通道编号为0，数据帧类型为0。
- 数据帧数据区采用公共通道加密方式。

# 应用

## UART2广播

当产品配置启用`PRODUCT_UART2_BOARDCAST`时,UART2接收的数据将通过广播数据帧发送出去，接收到的广播数据帧也将通过UART2发送出去。

注意:

- 每次发送的数据不应超过28字节(否则可能进行分包)。
- 发送间隔不小于75ms(更快的速度应当使用C语言开发)。